<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        #buscador {
            margin-top: 20px;
        }

        aside {
            min-height: 100vh;
            position: sticky;
            top: 0;
        }

        #boton2 {
            margin-top: 10px;
        }

        @media (max-width: 768px) {

            /* El panel de filtros inicia oculto y a pantalla completa si se habilita */
            #panel-filtros {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                width: 260px;
                background: white;
                z-index: 9999;
                overflow-y: auto;
                border-right: 1px solid #ccc;
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }

            #panel-filtros.mostrar {
                transform: translateX(0);
            }

            /* El main debe ocupar todo */
            main {
                width: 100% !important;
            }

            /* El botón queda siempre visible */
            .btn-toggle-filtros {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 10000;
                border-radius: 50px;
                padding: 12px 18px;
            }
        }
    </style>

</head>

<body class="bg-light">
    <div id="header"></div>
    <div class="container" id="buscador">
        <form class="form-inline">
            <div class="input-group">
                <input class="form-control" type="search" placeholder="Buscar producto" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Buscar &#128269</button>
            </div>
        </form>
    </div>

    <div class="container-fluid">
        <div class="row">

            <!-- Filtros laterales -->
            <aside id="panel-filtros" class="col-md-3 col-lg-2 bg-light p-3 border-end">

                <h5 class="mb-3">Filtros</h5>

                <!-- Filtro por marca -->
                <div class="mb-4">
                    <h6>Marca</h6>
                    <div id="filtro-marcas"></div>
                </div>

                <!-- Filtro por categoría -->
                <div class="mb-4">
                    <h6>Categoría</h6>
                    <div id="filtro-categorias"></div>
                </div>

                <!-- Filtro por precio -->
                <div class="mb-4">
                    <h6>Precio</h6>
                    <input type="range" id="precioMax" class="form-range" min="0" max="500" step="10">
                    <span id="precioValor">500 €</span>
                </div>

                <button class="btn btn-dark w-100" onclick="aplicarFiltros()">Aplicar filtros</button>
                <button id="boton2" class="btn btn-dark w-100" onclick="borrarFiltros()">Borrar filtros</button>

            </aside>
            <main class="col-md-9 col-lg-10 p-4">
                <button class="btn btn-outline-dark mb-3 btn-toggle-filtros" onclick="toggleFiltros()">
                    Mostrar / Ocultar filtros
                </button>
                <!--Aqui va la zona de productos mas las opciones de ordenamiento por precio....-->
                <div class="toolbar js-Toolbar">
                    <div class="toolbar__title">
                        <div class="Search-title">
                            <span class="js-Search-title">
                                Toda la ropa
                            </span>
                            <span class="Search-titleCount js-ContadorProductos">
                                (1664)
                            </span>
                        </div>
                    </div>
                    <div class="toolbar__switchs">
                        <span class="toolbar__switchSort">
                            <label class="toolbar__sortLabel" for="barraOpciones">Ordenar por </label>
                            <span class="toolbar__sortForm" data-automation-id="header-search-filter-block">
                                <select id="barraOpciones" class="toolbar__sortSelect js-SearchSorter"
                                    data-automation-id="open-header-search-filter-button">
                                    <option value="0" selected data-automation-id="header-search-filter-0">Destacados
                                    </option>
                                    <option value="5" data-automation-id="header-search-filter-5">Más baratos primero
                                    </option>
                                    <option value="500" data-automation-id="header-search-filter-500">Más caros primero
                                    </option>
                                    <option value="600" data-automation-id="header-search-filter-600">Especiales
                                    </option>
                                </select>
                                <svg aria-hidden="true" class="toolbar__sortSelectArrow f-icon" data-automation-id=""
                                    focusable="false" height="20" role="">
                                    <use xlink:href="/Assets/dist/nav/_a49552e6b0c2ad32.svg#$" />
                                </svg>
                            </span>
                        </span>

                    </div>
                </div>
                <h3>Productos</h3>
                <div id="lista-productos" class="row"></div>
            </main>
        </div>
    </div>
    <!--Sección  del footer-->
    <div id="footer"></div>
    <script>
        let productosOriginales = [];

        // Cargar marcas
        async function cargarMarcas() {
            const res = await fetch("http://localhost:8080/api/brands");
            const marcas = await res.json();
            const contenedor = document.getElementById("filtro-marcas");
            marcas.forEach(marca => {
                contenedor.innerHTML += `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="${marca.name}" id="marca-${marca.id}">
        <label class="form-check-label" for="marca-${marca.id}">${marca.name}</label>
      </div>
    `;
            });
        }

        // Cargar categorías
        async function cargarCategorias() {
            const res = await fetch("http://localhost:8080/api/categories");
            const categorias = await res.json();

            const contenedor = document.getElementById("filtro-categorias");
            categorias.forEach(categoria => {
                contenedor.innerHTML += `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="${categoria.name}" id="cat-${categoria.id}">
        <label class="form-check-label" for="cat-${categoria.id}">${categoria.name}</label>
      </div>
    `;
            });
        }

        // Cargar productos
        async function cargarProductos() {
            /*Como en la api el controlador de productos tiene la paginacion por defecto page y size entonces le pasamos por url el tamaño de la pagina
            y la cantidad de los productos en este caso le pasamos 500*/
            const res = await fetch("http://localhost:8080/api/products?page=0&size=500");
            const data = await res.json();

            productosOriginales = data.content;
            console.log(productosOriginales);
            mostrarProductos(productosOriginales);
        }

        // Mostrar productos
        function mostrarProductos(productos) {
            const contenedor = document.getElementById("lista-productos");
            contenedor.innerHTML = "";


            productos.forEach(producto => {
                contenedor.innerHTML += `
      <div class="col-md-4 mb-4">
        <div class="card h-100">
          <img src="${producto.imageUrl}" class="card-img-top" alt="${producto.name}">
          <div class="card-body">
            <h5>${producto.name}</h5>
            <p>${producto.price} €</p>
          </div>
        </div>
      </div> 
    `;
            });
            ContadorProductos(productos.length);
        }
        async function loadFragment(url, targetId) {
            try {
                const res = await fetch(url, { cache: "no-cache" });
                if (!res.ok) throw new Error(res.status + " " + res.statusText);
                const html = await res.text();
                const el = document.getElementById(targetId);
                if (el) el.innerHTML = html;
                else console.warn("Elemento no encontrado:", targetId);
            } catch (err) {
                console.error("Error cargando", url, err);
            }
        }
        function aplicarFiltros() {

            // Aqui aplicamos el filtro de las marcas seleccionadas
            const marcasSeleccionadas = Array.from(
                document.querySelectorAll("#filtro-marcas input:checked")
            ).map(el => el.value);

            // y aqui aplicamos el filtro de las categorías seleccionadas
            const categoriasSeleccionadas = Array.from(
                document.querySelectorAll("#filtro-categorias input:checked")
            ).map(el => el.value);

            // Precio máximo
            const precioMax = document.getElementById("precioMax").value;

            let productosFiltrados = productosOriginales.filter(p => {

                const cumpleMarca = marcasSeleccionadas.length === 0 ||
                    marcasSeleccionadas.includes(p.brand.name);

                const cumpleCategoria = categoriasSeleccionadas.length === 0 ||
                    categoriasSeleccionadas.includes(p.category.name);

                const cumplePrecio = p.price <= precioMax;

                return cumpleMarca && cumpleCategoria && cumplePrecio;
            });
            let opciones = document.getElementById("barraOpciones").value;
            productosFiltrados = ordenarLista(productosFiltrados, opciones);

            mostrarProductos(productosFiltrados);
        }
        /*Funcion para el borrado de los filtros seleccionados*/
        function borrarFiltros(productosFiltrados) {
            document.querySelectorAll("#filtro-marcas input")
                .forEach(input => input.checked = false);

            document.querySelectorAll("#filtro-categorias input")
                .forEach(input => input.checked = false);

            let slider = document.getElementById("precioMax");
            slider.value = slider.max;
            document.getElementById("precioValor").textContent = slider.max + " €";

            mostrarProductos(productosOriginales);


        }

        // Actualizamos valor de precio cuando movemos la barra o slider
        const slider = document.getElementById("precioMax");
        const precioTexto = document.getElementById("precioValor");

        slider.addEventListener("input", () => {
            precioTexto.innerText = slider.value + " €";
        });

        /*Funcion para mostrar/ocultar la seccion de los filtros*/

        let filtrosVisibles = false;

        function toggleFiltros() {
            const filtros = document.getElementById("panel-filtros");

            // En móvil usamos la clase "mostrar"
            if (window.innerWidth <= 768) {
                filtros.classList.toggle("mostrar");
                return;
            }

            // En escritorio seguimos usando bootstrap
            const productos = document.querySelector("main");

            if (filtrosVisibles) {
                filtros.classList.add("d-none");
                productos.classList.remove("col-md-9", "col-lg-10");
                productos.classList.add("col-12");
            } else {
                filtros.classList.remove("d-none");
                productos.classList.remove("col-12");
                productos.classList.add("col-md-9", "col-lg-10");
            }

            filtrosVisibles = !filtrosVisibles;
        }

        /*Funciones para el funcionamiento de la ordenacion de los productos y cantidad que se muestra*/

        function ContadorProductos(num) {
            document.querySelector(".js-ContadorProductos").textContent = `(${num})`;
        }
        function ordenarProductos() {
            let opciones = document.getElementById("barraOpciones").value;
            let productosOrdenados = [...productosOriginales];
            switch (opciones) {
                case "5":
                    productosOrdenados.sort((a, b) => a.price - b.price);
                    break;
                case "500":
                    productosOrdenados.sort((a, b) => b.price - a.price);
                    break;
                case "600":
                    productosOrdenados = productosOriginales.filter(p => p.featured === true);
                    break;
                default:
                    productosOrdenados = [...productosOriginales];
            }
            mostrarProductos(productosOrdenados);
        }

        function ordenarLista(lista, opcion) {
            let productosOrdenados = [...lista];
            switch (opcion) {
                case "5":
                    productosOrdenados.sort((a, b) => a.price - b.price);
                    break;
                case "500":
                    productosOrdenados.sort((a, b) => b.price - a.price);
                    break;
                case "600":
                    productosOrdenados = lista.filter(p => p.featured === true);
                    break;
                default:
                    productosOrdenados = [...lista];
            }
            return productosOrdenados;
        }
        window.onload = () => {
            cargarMarcas();
            cargarCategorias();
            cargarProductos();
        };
        // Cargar header y footer
        loadFragment("header.html", "header");
        loadFragment("footer.html", "footer");
    </script>


</body>

</html>